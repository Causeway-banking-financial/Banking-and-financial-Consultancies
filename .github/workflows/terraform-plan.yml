name: Terraform Plan

on:
  pull_request:
    paths:
      - "infrastructure/**"
      - ".github/workflows/terraform-*.yml"

permissions:
  contents: read
  id-token: write
  pull-requests: write

env:
  TF_VERSION: "1.7.0"
  AWS_REGION: "eu-west-1"

jobs:
  plan:
    name: Plan (${{ matrix.environment }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [nonprod, prod]
      fail-fast: false

    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.TERRAFORM_PLAN_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform fmt check
        working-directory: infrastructure/environments/${{ matrix.environment }}
        run: terraform fmt -check -recursive

      - name: Terraform init
        working-directory: infrastructure/environments/${{ matrix.environment }}
        run: terraform init -input=false

      - name: Terraform validate
        working-directory: infrastructure/environments/${{ matrix.environment }}
        run: terraform validate

      - name: Terraform plan
        id: plan
        working-directory: infrastructure/environments/${{ matrix.environment }}
        run: |
          set +e
          terraform plan -input=false -no-color -out=tfplan 2>&1 | tee plan-output.txt
          echo "plan_exit_code=${PIPESTATUS[0]}" >> "$GITHUB_OUTPUT"
        continue-on-error: true

      - name: Comment plan on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync(
              `infrastructure/environments/${{ matrix.environment }}/plan-output.txt`,
              'utf8'
            );
            const truncated = plan.length > 60000
              ? plan.substring(0, 60000) + '\n\n... (truncated)'
              : plan;

            const body = `### Terraform Plan â€” \`${{ matrix.environment }}\`

\`\`\`
${truncated}
\`\`\`

*Triggered by @${{ github.actor }} in ${{ github.sha }}*`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Fail if plan errored
        if: steps.plan.outputs.plan_exit_code != '0'
        run: exit 1
